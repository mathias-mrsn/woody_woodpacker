#include "exploit.h"

static void *fill_buffer(const STORED_FILE *sf, const ELF64_FORMAT *elf, int32_t idx)
{
    void *buf;
    buf = malloc(sf->size);
    memcpy(buf, sf->ptr, (size_t)(elf->p_h[idx].p_offset + elf->p_h[idx].p_filesz));
    return buf;
}

void elf_exploit(const STORED_FILE *sf, int bin_arch)
{

    int32_t text_index;
    int32_t segment;
    void *elf;
    void *buf;

    if (bin_arch == x64)
    {
        ELF64_FORMAT *tmp;

        tmp = malloc(sizeof(ELF64_FORMAT));
        tmp->e_h = (Elf64_Ehdr *)sf->ptr;
        tmp->s_h = (Elf64_Shdr *)(sf->ptr + tmp->e_h->e_shoff);
        tmp->p_h = (Elf64_Phdr *)(sf->ptr + tmp->e_h->e_phoff);
        elf = tmp;
    }
    else
    {
        ELF32_FORMAT *tmp;

        tmp = malloc(sizeof(ELF64_FORMAT));
        tmp->e_h = (Elf32_Ehdr *)sf->ptr;
        tmp->s_h = (Elf32_Shdr *)(sf->ptr + tmp->e_h->e_shoff);
        tmp->p_h = (Elf32_Phdr *)(sf->ptr + tmp->e_h->e_phoff);
        elf = tmp;
    }
    /*if (bin_arch == x64)
    {
        elf->e_h = (Elf64_Ehdr *)sf->ptr;
        elf->s_h = (Elf64_Shdr *)(sf->ptr + ((Elf64_Ehdr *)(elf->e_h))->e_shoff);
        elf->p_h = (Elf64_Phdr *)(sf->ptr + ((Elf64_Ehdr *)(elf->e_h))->e_phoff);
    }
    else
    {
        elf->e_h = (Elf32_Ehdr *)sf->ptr;
        elf->s_h = (Elf32_Shdr *)(sf->ptr + ((Elf32_Ehdr *)(elf->e_h))->e_shoff);
        elf->p_h = (Elf32_Phdr *)(sf->ptr + ((Elf32_Ehdr *)(elf->e_h))->e_phoff);
    }*/
    text_index = get_text_section(sf, elf);
    if (text_index < 0)
        goto _no_text;
    segment = find_text_segment(sf, elf, text_index);
    buf = fill_buffer(sf, elf, segment);
    Elf64_Ehdr *e_h;
    Elf64_Phdr *p_h;
    e_h = (Elf64_Ehdr *)buf;
    p_h = (Elf64_Phdr *)(buf + e_h->e_phoff);
    printf("%lx\n%lx\n", e_h->e_entry, e_h->e_phoff);
    printf("Program Header Entries:\n");
    printf("==================================\n");
    printf("Type\tOffset\t\tVirtAddr\tPhysAddr\tFileSiz\tMemSiz\tFlags\tAlign\n");

    for (int i = 0; i < e_h->e_phnum; i++)
    {
        printf("%x\t%08lx\t%016lx\t%016lx\t%08lx\t%08lx\t%x\t%lx\n",
               p_h[i].p_type, p_h[i].p_offset, p_h[i].p_vaddr,
               p_h[i].p_paddr, p_h[i].p_filesz, p_h[i].p_memsz,
               p_h[i].p_flags, p_h[i].p_align);
    }
    free(buf);
    free(elf);

    return;

_no_text:
    printf("find PT_LOAD brooo ");
    // find_pt_load();
}